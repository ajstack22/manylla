# android/fastlane/Fastfile
# Manylla Android Fastlane Configuration
# Adapted from SmilePile's proven configuration

default_platform(:android)

platform :android do

  # LANE 1: QUAL - APK builds for local emulator testing
  desc "Build QUAL APK for emulator testing"
  lane :qual do
    gradle(
      task: "clean assembleQualDebug",
      project_dir: ".",
      print_command: true
    )

    apk_path = lane_context[SharedValues::GRADLE_APK_OUTPUT_PATH]
    puts ""
    puts "âœ… QUAL APK built: #{apk_path}"
    puts "ğŸ“² To install: adb install -r #{apk_path}"
    puts "ğŸš€ To launch: adb shell monkey -p com.manylla.qual -c android.intent.category.LAUNCHER 1"
    puts ""
  end

  # LANE 2: STAGE - Play Console Internal Testing
  desc "Build and upload STAGE to Play Console Internal Testing"
  lane :stage do
    gradle(
      task: "clean bundleStageRelease",
      project_dir: ".",
      print_command: true,
      print_command_output: true
    )

    upload_to_play_store(
      track: "internal",
      release_status: "completed",
      aab: "app/build/outputs/bundle/stageRelease/app-stage-release.aab",
      skip_upload_apk: true,
      skip_upload_metadata: true,
      skip_upload_changelogs: false,
      skip_upload_images: true,
      skip_upload_screenshots: true,
      validate_only: false
    )

    puts ""
    puts "âœ… STAGE uploaded to Play Console Internal Testing!"
    puts "ğŸ”— View: https://play.google.com/console"
    puts ""
  end

  # LANE 3: BETA - Play Console Closed Testing
  desc "Build and upload BETA to Play Console Closed Testing"
  lane :beta do
    gradle(
      task: "clean bundleBetaRelease",
      project_dir: ".",
      print_command: true
    )

    upload_to_play_store(
      track: "beta",
      release_status: "completed",
      aab: "app/build/outputs/bundle/betaRelease/app-beta-release.aab",
      skip_upload_apk: true,
      skip_upload_metadata: true,
      skip_upload_changelogs: false,
      skip_upload_images: true,
      skip_upload_screenshots: true
    )

    puts ""
    puts "âœ… BETA uploaded to Play Console Closed Testing!"
    puts "ğŸ”— View: https://play.google.com/console"
    puts ""
  end

  # LANE 4: PROD - Play Console Production
  desc "Build and upload PROD to Play Console Production"
  lane :prod do
    gradle(
      task: "clean bundleProdRelease",
      project_dir: ".",
      print_command: true
    )

    upload_to_play_store(
      track: "production",
      release_status: "draft",  # Draft for manual rollout control
      aab: "app/build/outputs/bundle/prodRelease/app-prod-release.aab",
      skip_upload_apk: true,
      skip_upload_metadata: true,
      skip_upload_changelogs: false,
      skip_upload_images: true,
      skip_upload_screenshots: true
    )

    puts ""
    puts "âœ… PROD uploaded to Play Console (draft)!"
    puts "âš ï¸  Manual rollout required in Play Console"
    puts "ğŸ”— https://play.google.com/console"
    puts ""
  end

  # Error handling
  error do |lane, exception|
    puts ""
    puts "âŒ Lane #{lane} failed: #{exception.message}"
    puts ""
  end

end
